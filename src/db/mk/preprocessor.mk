################################################################################
## CONFIG ######################################################################
################################################################################
CONFIG_FILE ?= ${CURDIR}/module.conf

################################################################################
## MAKEFILE MAGIC ##############################################################
################################################################################
PREPROCESSOR_FILES = $(shell find ${CURDIR} -name "*.m4")
PREPROCESSED_FILES = $(patsubst %.m4,%,$(PREPROCESSOR_FILES))

MAKEFILE_TO_M4 = \
	--define=__MAKEFILE_MODULE_NAME=$(MODULE_NAME) \
	--define=__MAKEFILE_MODULE_PORT=$(MODULE_PORT) \
	--define=__MAKEFILE_BIN_DIR=$(BIN_DIR) \
	--define=__MAKEFILE_INCLUDE_DIR=$(INCLUDE_DIR)

################################################################################
## SANITY CHECKS ###############################################################
################################################################################
ifeq ($(wildcard $(CONFIG_FILE)),)
$(error "Missing CONFIG_FILE ($(CONFIG_FILE)).")
endif

################################################################################
## TARGET RULES ################################################################
################################################################################
PREPROCESSOR_RESULT = $(PREPROCESSED_FILES)

################################################################################
## INTERNAL RULES ##############################################################
################################################################################
$(PREPROCESSED_FILES): %: $(CONFIG_FILE) %.m4
	m4 -P $^ > $@
