################################################################################
## CONFIG ######################################################################
################################################################################
CONFIG_FILE ?= ${CURDIR}/module.conf

################################################################################
## MAKEFILE MAGIC ##############################################################
################################################################################
PREPROCESSOR_FILES = $(shell find ${CURDIR} -name "*.m4")
PREPROCESSED_FILES = $(patsubst %.m4,%,$(PREPROCESSOR_FILES))

################################################################################
## SANITY CHECKS ###############################################################
################################################################################
ifeq ($(wildcard $(CONFIG_FILE)),)
$(error "Missing CONFIG_FILE ($(CONFIG_FILE)).")
endif

################################################################################
## TARGET RULES ################################################################
################################################################################
PREPROCESSOR_RESULT = $(PREPROCESSED_FILES)

################################################################################
## INTERNAL RULES ##############################################################
################################################################################
$(PREPROCESSED_FILES): %: $(CONFIG_FILE) %.m4
	m4 -P $^ > $@
